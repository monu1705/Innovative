<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Tester Dashboard - ProManage</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-light shadow-sm">
    <div class="container d-flex justify-content-between">
      <a class="navbar-brand" href="index.html">
        <i class="fas fa-project-diagram me-2"></i>ProManage
      </a>
      <div class="d-flex align-items-center gap-3">
        <span class="text-muted">
          <i class="fas fa-vial me-1"></i>Tester Dashboard
        </span>
        <button class="theme-toggle-sm btn btn-outline-secondary btn-sm" id="themeToggle" title="Toggle Theme">
          <i class="fas fa-moon" id="themeIcon"></i>
        </button>
        <a href="projects.html" class="btn btn-outline-primary btn-sm">
          <i class="fas fa-folder me-1"></i>All Projects
        </a>
        <button id="logoutBtn" class="btn btn-outline-danger btn-sm">
          <i class="fas fa-sign-out-alt me-1"></i>Logout
        </button>
      </div>
    </div>
  </nav>

  <div class="container my-5">
    <!-- Welcome Section -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card bg-gradient text-white animate-fade-in">
          <div class="card-body">
            <div class="row align-items-center">
              <div class="col-md-8 animate-fade-in-left">
                <h2 class="mb-2" id="welcomeMessage">Tester Dashboard</h2>
                <p class="mb-0 opacity-75">Manage test cases, report bugs, and track quality metrics</p>
              </div>
              <div class="col-md-4 text-end animate-fade-in-right">
                <i class="fas fa-vial fa-3x opacity-50"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
      <div class="col-md-3 mb-3">
        <div class="card stat-card">
          <div class="card-body text-center">
            <div class="stat-number" id="myBugs">0</div>
            <div class="stat-label">
              <i class="fas fa-bug me-1"></i>My Bugs
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-3 mb-3">
        <div class="card stat-card" style="background: var(--gradient-warm);">
          <div class="card-body text-center">
            <div class="stat-number" id="openBugs">0</div>
            <div class="stat-label">
              <i class="fas fa-exclamation-triangle me-1"></i>Open Bugs
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-3 mb-3">
        <div class="card stat-card" style="background: var(--gradient-success);">
          <div class="card-body text-center">
            <div class="stat-number" id="resolvedBugs">0</div>
            <div class="stat-label">
              <i class="fas fa-check-circle me-1"></i>Resolved
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-3 mb-3">
        <div class="card stat-card" style="background: var(--gradient-primary);">
          <div class="card-body text-center">
            <div class="stat-number" id="testTasks">0</div>
            <div class="stat-label">
              <i class="fas fa-tasks me-1"></i>Test Tasks
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <!-- Bugs Management -->
      <div class="col-lg-8 mb-4">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
              <i class="fas fa-bug me-2"></i>Bug Reports
            </h5>
            <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#createBugModal">
              <i class="fas fa-plus me-1"></i>Report Bug
            </button>
          </div>
          <div class="card-body p-0">
            <div id="bugsList" class="list-group list-group-flush">
              <!-- Bugs will be loaded here -->
            </div>
          </div>
        </div>
      </div>

      <!-- Testing Tasks -->
      <div class="col-lg-4 mb-4">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">
              <i class="fas fa-tasks me-2"></i>Testing Tasks
            </h5>
          </div>
          <div class="card-body p-0">
            <div id="testTasksList" class="list-group list-group-flush">
              <!-- Test tasks will be loaded here -->
            </div>
          </div>
        </div>

        <!-- Quality Metrics -->
        <div class="card mt-4">
          <div class="card-header">
            <h5 class="mb-0">
              <i class="fas fa-chart-bar me-2"></i>Quality Metrics
            </h5>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <div class="d-flex justify-content-between mb-1">
                <small>Bug Resolution Rate</small>
                <small id="resolutionRate">0%</small>
              </div>
              <div class="progress" style="height: 8px;">
                <div class="progress-bar" id="resolutionBar" role="progressbar" style="width: 0%"></div>
              </div>
            </div>
            <div class="mb-3">
              <div class="d-flex justify-content-between mb-1">
                <small>Critical Bugs</small>
                <small id="criticalBugs">0</small>
              </div>
            </div>
            <div>
              <div class="d-flex justify-content-between mb-1">
                <small>Average Resolution Time</small>
                <small id="avgResolutionTime">0 days</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Create Bug Modal -->
  <div class="modal fade" id="createBugModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Report New Bug</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="createBugForm">
            <div class="mb-3">
              <label class="form-label">Project</label>
              <select class="form-select" id="bugProject" required>
                <option value="">Select a project...</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Related Task</label>
              <select class="form-select" id="bugTask">
                <option value="">Select a task (optional)...</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Bug Title</label>
              <input type="text" class="form-control" id="bugTitle" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Description</label>
              <textarea class="form-control" id="bugDescription" rows="4" required></textarea>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Severity</label>
                <select class="form-select" id="bugSeverity" required>
                  <option value="low">Low</option>
                  <option value="medium">Medium</option>
                  <option value="high">High</option>
                  <option value="critical">Critical</option>
                </select>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Priority</label>
                <select class="form-select" id="bugPriority" required>
                  <option value="low">Low</option>
                  <option value="medium">Medium</option>
                  <option value="high">High</option>
                  <option value="critical">Critical</option>
                </select>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Steps to Reproduce</label>
              <textarea class="form-control" id="bugSteps" rows="3" placeholder="1. Step one&#10;2. Step two&#10;3. Step three"></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">Assign To</label>
              <select class="form-select" id="bugAssignee">
                <option value="">Unassigned</option>
              </select>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="createNewBug()">Report Bug</button>
        </div>
      </div>
    </div>
  </div>

  <script src="app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="notifications.js"></script>
  <script>
    // Theme Toggle
    const themeToggle = document.getElementById('themeToggle');
    const themeIcon = document.getElementById('themeIcon');
    const THEME_KEY = 'promanage_theme';
    
    const savedTheme = localStorage.getItem(THEME_KEY) || 'light';
    if (savedTheme === 'dark') {
      document.documentElement.setAttribute('data-theme', 'dark');
      themeIcon.className = 'fas fa-sun';
    }

    themeToggle.addEventListener('click', () => {
      const currentTheme = document.documentElement.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      
      document.documentElement.setAttribute('data-theme', newTheme);
      themeIcon.className = newTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
      localStorage.setItem(THEME_KEY, newTheme);
    });

    ensureRole('tester');
    const currentUser = getCurrentUser();
    const memberId = getCurrentUserMemberId();

    function updateStats() {
      const allBugs = getAllBugs();
      const myBugs = allBugs.filter(b => b.reported_by === memberId);
      const openBugs = allBugs.filter(b => b.status === 'open');
      const resolvedBugs = allBugs.filter(b => b.status === 'resolved');
      const testTasks = getAllTasks().filter(t => t.status === 'testing' && t.assigned_to === memberId);

      document.getElementById('myBugs').textContent = myBugs.length;
      document.getElementById('openBugs').textContent = openBugs.length;
      document.getElementById('resolvedBugs').textContent = resolvedBugs.length;
      document.getElementById('testTasks').textContent = testTasks.length;

      // Quality metrics
      const totalBugs = allBugs.length;
      const resolutionRate = totalBugs > 0 ? Math.round((resolvedBugs.length / totalBugs) * 100) : 0;
      document.getElementById('resolutionRate').textContent = resolutionRate + '%';
      document.getElementById('resolutionBar').style.width = resolutionRate + '%';

      const criticalBugs = allBugs.filter(b => b.severity === 'critical' && b.status === 'open').length;
      document.getElementById('criticalBugs').textContent = criticalBugs;

      // Calculate average resolution time
      const resolvedBugsWithDates = resolvedBugs.filter(b => b.resolved_date && b.reported_date);
      if (resolvedBugsWithDates.length > 0) {
        const totalDays = resolvedBugsWithDates.reduce((sum, b) => {
          const days = Math.ceil((new Date(b.resolved_date) - new Date(b.reported_date)) / (1000 * 60 * 60 * 24));
          return sum + days;
        }, 0);
        const avgDays = Math.round(totalDays / resolvedBugsWithDates.length);
        document.getElementById('avgResolutionTime').textContent = avgDays + ' days';
      }
    }

    function renderBugs() {
      const allBugs = getAllBugs().sort((a, b) => new Date(b.reported_date) - new Date(a.reported_date));
      const container = document.getElementById('bugsList');
      
      if (allBugs.length === 0) {
        container.innerHTML = `
          <div class="list-group-item text-center py-5">
            <i class="fas fa-bug fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">No bugs reported yet</h5>
          </div>
        `;
        return;
      }

      container.innerHTML = allBugs.map(b => {
        const project = getProjectById(b.project_id);
        const task = b.task_id ? getTaskById(b.task_id) : null;
        const assignee = b.assigned_to ? getTeamMemberById(b.assigned_to) : null;
        const reporter = getTeamMemberById(b.reported_by);
        const severityColors = {
          'critical': 'danger',
          'high': 'warning',
          'medium': 'info',
          'low': 'secondary'
        };
        const statusColors = {
          'resolved': 'success',
          'open': 'danger',
          'in_progress': 'warning',
          'closed': 'secondary'
        };
        
        return `
          <div class="list-group-item">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <div class="flex-grow-1">
                <h6 class="mb-1">
                  ${b.title}
                  <span class="badge bg-${severityColors[b.severity] || 'secondary'} ms-2">${b.severity}</span>
                  <span class="badge bg-${statusColors[b.status] || 'secondary'} ms-1">${b.status}</span>
                  <span class="badge bg-${getPriorityColor(b.priority)} ms-1">${b.priority}</span>
                </h6>
                <p class="text-muted small mb-2">${b.description}</p>
                <div class="d-flex gap-3 mb-2">
                  <small class="text-muted">
                    <i class="fas fa-project-diagram me-1"></i>${project?.name || 'Unknown Project'}
                  </small>
                  ${task ? `<small class="text-muted"><i class="fas fa-tasks me-1"></i>${task.title}</small>` : ''}
                  ${assignee ? `<small class="text-muted"><i class="fas fa-user me-1"></i>Assigned to: ${assignee.name}</small>` : ''}
                  <small class="text-muted">
                    <i class="fas fa-user-edit me-1"></i>Reported by: ${reporter?.name || 'Unknown'}
                  </small>
                </div>
                ${b.steps_to_reproduce ? `
                  <div class="alert alert-info small mb-2">
                    <strong>Steps to Reproduce:</strong><br>
                    ${b.steps_to_reproduce.replace(/\n/g, '<br>')}
                  </div>
                ` : ''}
                <small class="text-muted">
                  <i class="fas fa-calendar me-1"></i>Reported: ${new Date(b.reported_date).toLocaleDateString()}
                  ${b.resolved_date ? ` â€¢ Resolved: ${new Date(b.resolved_date).toLocaleDateString()}` : ''}
                </small>
              </div>
              <div class="ms-3">
                ${b.status === 'open' ? `
                  <button class="btn btn-sm btn-success" onclick="resolveBug('${b.id}')">
                    <i class="fas fa-check me-1"></i>Resolve
                  </button>
                ` : ''}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function getPriorityColor(priority) {
      const colors = {
        'critical': 'danger',
        'high': 'warning',
        'medium': 'info',
        'low': 'secondary'
      };
      return colors[priority] || 'secondary';
    }

    function resolveBug(bugId) {
      if (confirm('Mark this bug as resolved?')) {
        updateBugStatus(bugId, 'resolved');
        updateStats();
        renderBugs();
        alert('Bug marked as resolved!');
      }
    }

    window.resolveBug = resolveBug;

    function renderTestTasks() {
      const testTasks = getAllTasks().filter(t => t.status === 'testing' && t.assigned_to === memberId);
      const container = document.getElementById('testTasksList');
      
      if (testTasks.length === 0) {
        container.innerHTML = '<div class="list-group-item text-center py-4 text-muted">No testing tasks</div>';
        return;
      }

      container.innerHTML = testTasks.map(t => {
        const project = getProjectById(t.project_id);
        return `
          <div class="list-group-item">
            <h6 class="mb-1 small">${t.title}</h6>
            <small class="text-muted">${project?.name || 'Unknown Project'}</small>
            <div class="mt-2">
              <small class="text-muted">
                <i class="fas fa-calendar me-1"></i>Due: ${new Date(t.due_date).toLocaleDateString()}
              </small>
            </div>
          </div>
        `;
      }).join('');
    }

    function populateBugForm() {
      const projects = getAllProjects();
      const projectSelect = document.getElementById('bugProject');
      projectSelect.innerHTML = '<option value="">Select a project...</option>' +
        projects.map(p => `<option value="${p.id}">${p.name}</option>`).join('');

      projectSelect.addEventListener('change', function() {
        const projectId = this.value;
        const tasks = getTasksByProject(projectId);
        const taskSelect = document.getElementById('bugTask');
        taskSelect.innerHTML = '<option value="">Select a task (optional)...</option>' +
          tasks.map(t => `<option value="${t.id}">${t.title}</option>`).join('');
      });

      const developers = getAllTeamMembers().filter(m => m.role === 'developer' || m.role === 'programmer');
      const assigneeSelect = document.getElementById('bugAssignee');
      assigneeSelect.innerHTML = '<option value="">Unassigned</option>' +
        developers.map(d => `<option value="${d.id}">${d.name}</option>`).join('');
    }

    function createNewBug() {
      const projectId = document.getElementById('bugProject').value;
      const taskId = document.getElementById('bugTask').value || null;
      const title = document.getElementById('bugTitle').value;
      const description = document.getElementById('bugDescription').value;
      const severity = document.getElementById('bugSeverity').value;
      const priority = document.getElementById('bugPriority').value;
      const steps = document.getElementById('bugSteps').value;
      const assigneeId = document.getElementById('bugAssignee').value || null;

      if (!projectId || !title || !description) {
        alert('Please fill in all required fields');
        return;
      }

      createBug(projectId, taskId, title, description, severity, priority, memberId, assigneeId);
      
      // Update steps to reproduce if provided
      const bugs = getAllBugs();
      const newBug = bugs[bugs.length - 1];
      if (newBug && steps) {
        newBug.steps_to_reproduce = steps;
        const d = loadData();
        const bugIndex = d.bugs.findIndex(b => b.id === newBug.id);
        if (bugIndex !== -1) {
          d.bugs[bugIndex].steps_to_reproduce = steps;
          saveData(d);
        }
      }

      const modal = bootstrap.Modal.getInstance(document.getElementById('createBugModal'));
      modal.hide();
      document.getElementById('createBugForm').reset();
      
      updateStats();
      renderBugs();
      
      alert('Bug reported successfully!');
    }

    window.createNewBug = createNewBug;

    document.getElementById('logoutBtn').addEventListener('click', logout);

    // Set welcome message
    const member = getTeamMemberById(memberId);
    if (member) {
      document.getElementById('welcomeMessage').textContent = `Welcome, ${member.name.split(' ')[0]}!`;
    }

    updateStats();
    renderBugs();
    renderTestTasks();
    populateBugForm();
  </script>
</body>
</html>

