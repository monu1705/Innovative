<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Projects - ProManage</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-light shadow-sm">
    <div class="container d-flex justify-content-between">
      <a class="navbar-brand" href="index.html">
        <i class="fas fa-project-diagram me-2"></i>ProManage
      </a>
      <div class="d-flex align-items-center gap-3">
        <span class="text-muted">
          <i class="fas fa-folder me-1"></i>All Projects
        </span>
        <button class="theme-toggle-sm btn btn-outline-secondary btn-sm" id="themeToggle" title="Toggle Theme">
          <i class="fas fa-moon" id="themeIcon"></i>
        </button>
        <button id="backBtn" class="btn btn-outline-secondary btn-sm">
          <i class="fas fa-arrow-left me-1"></i>Back
        </button>
        <button id="logoutBtn" class="btn btn-outline-danger btn-sm">
          <i class="fas fa-sign-out-alt me-1"></i>Logout
        </button>
      </div>
    </div>
  </nav>

  <div class="container my-5">
    <!-- Header Section -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card bg-gradient text-white">
          <div class="card-body">
            <div class="row align-items-center">
              <div class="col-md-8">
                <h2 class="mb-2">All Projects</h2>
                <p class="mb-0 opacity-75">Browse and manage all projects in the system</p>
              </div>
              <div class="col-md-4 text-end">
                <i class="fas fa-project-diagram fa-3x opacity-50"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Filters -->
    <div class="filter-section mb-4">
      <h6>
        <i class="fas fa-filter"></i>
        Filter Projects
      </h6>
      <div class="filter-row">
        <div class="filter-group">
          <label>Status</label>
          <select id="statusFilter" class="form-select">
            <option value="all">All Status</option>
            <option value="active">Active</option>
            <option value="completed">Completed</option>
            <option value="planning">Planning</option>
            <option value="on_hold">On Hold</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Priority</label>
          <select id="priorityFilter" class="form-select">
            <option value="all">All Priorities</option>
            <option value="critical">Critical</option>
            <option value="high">High</option>
            <option value="medium">Medium</option>
            <option value="low">Low</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Search</label>
          <input type="text" id="searchInput" class="form-control" placeholder="Search projects...">
        </div>
        <div class="filter-group">
          <label>View</label>
          <select id="viewMode" class="form-select">
            <option value="list">List View</option>
            <option value="kanban">Kanban Board</option>
          </select>
        </div>
      </div>
      <div class="filter-actions">
        <button id="clearFilters" class="btn btn-outline-secondary">
          <i class="fas fa-times me-1"></i>Clear Filters
        </button>
      </div>
    </div>

    <!-- Projects List -->
    <div id="projectsContainer" class="row">
      <!-- Projects will be loaded here -->
    </div>

    <!-- Kanban Board -->
    <div id="kanbanBoard" style="display: none;">
      <div class="row">
        <div class="col-md-3 mb-4">
          <div class="card">
            <div class="card-header bg-secondary text-white">
              <h6 class="mb-0">Planning</h6>
            </div>
            <div class="card-body" id="kanban-planning">
              <!-- Projects will be loaded here -->
            </div>
          </div>
        </div>
        <div class="col-md-3 mb-4">
          <div class="card">
            <div class="card-header bg-primary text-white">
              <h6 class="mb-0">Active</h6>
            </div>
            <div class="card-body" id="kanban-active">
              <!-- Projects will be loaded here -->
            </div>
          </div>
        </div>
        <div class="col-md-3 mb-4">
          <div class="card">
            <div class="card-header bg-warning text-white">
              <h6 class="mb-0">On Hold</h6>
            </div>
            <div class="card-body" id="kanban-onhold">
              <!-- Projects will be loaded here -->
            </div>
          </div>
        </div>
        <div class="col-md-3 mb-4">
          <div class="card">
            <div class="card-header bg-success text-white">
              <h6 class="mb-0">Completed</h6>
            </div>
            <div class="card-body" id="kanban-completed">
              <!-- Projects will be loaded here -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="app.js"></script>
  <script src="notifications.js"></script>
  <script>
    // Theme Toggle
    const themeToggle = document.getElementById('themeToggle');
    const themeIcon = document.getElementById('themeIcon');
    const THEME_KEY = 'promanage_theme';
    
    const savedTheme = localStorage.getItem(THEME_KEY) || 'light';
    if (savedTheme === 'dark') {
      document.documentElement.setAttribute('data-theme', 'dark');
      themeIcon.className = 'fas fa-sun';
    }

    themeToggle.addEventListener('click', () => {
      const currentTheme = document.documentElement.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      
      document.documentElement.setAttribute('data-theme', newTheme);
      themeIcon.className = newTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
      localStorage.setItem(THEME_KEY, newTheme);
    });

    let allProjects = [];
    let filteredProjects = [];

    function loadProjects() {
      allProjects = getAllProjects();
      filteredProjects = [...allProjects];
      renderProjects();
    }

    function filterProjects() {
      const status = document.getElementById('statusFilter').value;
      const priority = document.getElementById('priorityFilter').value;
      const search = document.getElementById('searchInput').value.toLowerCase();

      filteredProjects = allProjects.filter(p => {
        if (status !== 'all' && p.status !== status) return false;
        if (priority !== 'all' && p.priority !== priority) return false;
        if (search && !p.name.toLowerCase().includes(search) && !p.description.toLowerCase().includes(search)) return false;
        return true;
      });

      renderProjects();
    }

    function renderProjects() {
      const viewMode = document.getElementById('viewMode').value;
      
      if (viewMode === 'kanban') {
        renderKanbanBoard();
      } else {
        renderListView();
      }
    }

    function renderListView() {
      document.getElementById('projectsContainer').style.display = 'block';
      document.getElementById('kanbanBoard').style.display = 'none';
      
      const container = document.getElementById('projectsContainer');
      
      if (filteredProjects.length === 0) {
        container.innerHTML = `
          <div class="col-12 text-center py-5">
            <i class="fas fa-project-diagram fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">No projects found</h5>
            <p class="text-muted">Try adjusting your filters</p>
          </div>
        `;
        return;
      }

      container.innerHTML = filteredProjects.map(p => {
        const pm = getTeamMemberById(p.project_manager_id);
        const tasks = getTasksByProject(p.id);
        const completedTasks = tasks.filter(t => t.status === 'completed').length;
        const progress = tasks.length > 0 ? Math.round((completedTasks / tasks.length) * 100) : 0;
        const statusColors = {
          'active': 'success',
          'completed': 'primary',
          'planning': 'secondary',
          'on_hold': 'warning'
        };
        const priorityColors = {
          'critical': 'danger',
          'high': 'warning',
          'medium': 'info',
          'low': 'secondary'
        };
        
        return `
          <div class="col-lg-6 col-xl-4 mb-4">
            <div class="card h-100 enhanced-card hover-lift">
              <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">${p.name}</h6>
                <div>
                  <span class="badge bg-${statusColors[p.status] || 'secondary'}">${p.status}</span>
                  <span class="badge bg-${priorityColors[p.priority] || 'secondary'} ms-1">${p.priority}</span>
                </div>
              </div>
              <div class="card-body">
                <p class="text-muted small mb-3">${p.description}</p>
                <div class="mb-3">
                  <div class="d-flex justify-content-between mb-1">
                    <small class="text-muted">Progress</small>
                    <small class="text-muted">${progress}%</small>
                  </div>
                  <div class="progress" style="height: 8px;">
                    <div class="progress-bar" role="progressbar" style="width: ${progress}%">${progress}%</div>
                  </div>
                </div>
                <div class="row text-center mb-3">
                  <div class="col-4">
                    <small class="text-muted d-block">Tasks</small>
                    <strong>${tasks.length}</strong>
                  </div>
                  <div class="col-4">
                    <small class="text-muted d-block">Team</small>
                    <strong>${p.team_ids.length}</strong>
                  </div>
                  <div class="col-4">
                    <small class="text-muted d-block">Budget</small>
                    <strong>$${(p.budget / 1000).toFixed(0)}k</strong>
                  </div>
                </div>
                <div class="mb-2">
                  <small class="text-muted">
                    <i class="fas fa-user-tie me-1"></i>PM: ${pm?.name || 'Unassigned'}
                  </small>
                </div>
                <div class="mb-2">
                  <small class="text-muted">
                    <i class="fas fa-calendar me-1"></i>Due: ${new Date(p.end_date).toLocaleDateString()}
                  </small>
                </div>
              </div>
              <div class="card-footer">
                <a href="?project=${p.id}" class="btn btn-primary btn-sm w-100">
                  <i class="fas fa-eye me-1"></i>View Details
                </a>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderKanbanBoard() {
      document.getElementById('projectsContainer').style.display = 'none';
      document.getElementById('kanbanBoard').style.display = 'block';

      const planning = document.getElementById('kanban-planning');
      const active = document.getElementById('kanban-active');
      const onHold = document.getElementById('kanban-onhold');
      const completed = document.getElementById('kanban-completed');

      planning.innerHTML = '';
      active.innerHTML = '';
      onHold.innerHTML = '';
      completed.innerHTML = '';

      filteredProjects.forEach(p => {
        const pm = getTeamMemberById(p.project_manager_id);
        const tasks = getTasksByProject(p.id);
        const completedTasks = tasks.filter(t => t.status === 'completed').length;
        const progress = tasks.length > 0 ? Math.round((completedTasks / tasks.length) * 100) : 0;
        
        const card = `
          <div class="card mb-3">
            <div class="card-body">
              <h6 class="mb-2">${p.name}</h6>
              <p class="text-muted small mb-2">${p.description.substring(0, 80)}...</p>
              <div class="progress mb-2" style="height: 4px;">
                <div class="progress-bar" style="width: ${progress}%"></div>
              </div>
              <small class="text-muted">
                <i class="fas fa-tasks me-1"></i>${tasks.length} tasks â€¢ 
                <i class="fas fa-users me-1"></i>${p.team_ids.length} members
              </small>
            </div>
          </div>
        `;

        if (p.status === 'planning') planning.innerHTML += card;
        else if (p.status === 'active') active.innerHTML += card;
        else if (p.status === 'on_hold') onHold.innerHTML += card;
        else if (p.status === 'completed') completed.innerHTML += card;
      });
    }

    function clearFilters() {
      document.getElementById('statusFilter').value = 'all';
      document.getElementById('priorityFilter').value = 'all';
      document.getElementById('searchInput').value = '';
      filteredProjects = [...allProjects];
      renderProjects();
    }

    // Event listeners
    document.getElementById('statusFilter').addEventListener('change', filterProjects);
    document.getElementById('priorityFilter').addEventListener('change', filterProjects);
    document.getElementById('searchInput').addEventListener('input', filterProjects);
    document.getElementById('viewMode').addEventListener('change', renderProjects);
    document.getElementById('clearFilters').addEventListener('click', clearFilters);
    
    document.getElementById('backBtn').addEventListener('click', () => {
      const currentUser = getCurrentUser();
      if (!currentUser) {
        location.href = 'login.html';
        return;
      }
      const roleRoutes = {
        'admin': 'admin.html',
        'project_manager': 'pm.html',
        'developer': 'dev.html',
        'programmer': 'dev.html',
        'tester': 'tester.html'
      };
      location.href = roleRoutes[currentUser.role] || 'login.html';
    });

    document.getElementById('logoutBtn').addEventListener('click', logout);

    loadProjects();
  </script>
</body>
</html>

